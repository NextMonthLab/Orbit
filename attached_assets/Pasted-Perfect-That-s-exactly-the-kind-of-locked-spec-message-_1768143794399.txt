Perfect. That’s exactly the kind of “locked spec” message you want living in the repo.

Now let’s turn that into Milestone 7 implementation instructions that Replit/Claude can’t wriggle out of, plus a sane test harness so you can judge it like an editor.

⸻

Milestone 7: TitleComposer (string → string[])

Goal

Produce good looking headline line breaks (CapCut-ish cadence) without touching the Milestone 6 fitter.

Pipeline becomes:

rawText → TitleComposer(lines) → fitTextToBox(lines.join('\n')) → ScaleToFitCaption(render lines)

You can decide whether you feed fitter:
	•	Option A (recommended): already-composed lines joined with \n and tell fitter to treat \n as hard breaks (best control)
	•	Option B: pass the composed lines[] to fitter as “preferred breaks” but allow it to adjust if needed (more complexity)

Start with Option A.

⸻

What “success” looks like (hard acceptance criteria)

For every headline, TitleComposer must return:
	•	1–3 lines only
	•	No orphan last line (no 1-word last line unless it’s a number like “58%”)
	•	Each line ideally 2–4 words (5 allowed if needed)
	•	Balanced line lengths (no line massively longer than the others)
	•	Preserve original word order (no rewriting in Milestone 7)

If it can’t meet those constraints: return 2–3 lines that are “least bad”, and let the fitter shrink.

⸻

The exact work to do (in order)

1) Add TitleComposer.ts

Create:

client/src/caption-engine/layout/title/TitleComposer.ts

Exports:

export type TitleComposeOptions = {
  maxLines?: 3;
  targetWordsPerLine?: [number, number]; // default [2,4]
  allowSingleWordLineForNumbers?: boolean; // default true
};

export function composeTitleLines(text: string, opts?: TitleComposeOptions): string[];

2) The algorithm (simple but deterministic)

Do not overthink it. Do this:
	1.	Tokenise by spaces (collapse whitespace)
	2.	Identify “strong tokens”:
	•	numbers/percentages: /^\d+%?$/
	•	short punch words: 1–3 words groups like “right now”, “this year” are not special yet
	3.	Generate candidate splits:
	•	all ways to split into 1, 2, or 3 lines (bounded, because sentence length is small)
	4.	Score each candidate using penalties:
	•	orphan last line (1 word) = huge penalty unless numeric
	•	lines over 5 words = penalty
	•	difference in character lengths between lines = penalty
	•	last line longer than first line by a lot = penalty
	•	“dangling” tiny middle line = penalty
	5.	Pick best score, return those lines

This is deterministic and testable.

3) Add a test harness page (so you can judge taste)

Create:

client/src/pages/caption-composer-lab.tsx

It should:
	•	List 30 example headlines (real ones from your ICEs)
	•	Show:
	•	raw text
	•	composed lines result
	•	final rendered result in the actual panel using your existing style resolver + fitter

This is where you “direct” it.

4) Wire it in upstream (one line change conceptually)

Wherever you currently do:

headlineText → fitTextToBox(headlineText)

Change to:

headlineText → composeTitleLines(headlineText) → fitTextToBox(lines.join('\n'))

Then render respecting newlines (or render line array directly).

⸻

Things that MUST NOT happen (so we don’t loop again)
	•	Do not edit Milestone 6 files
	•	Do not add font scaling heuristics to TitleComposer
	•	Do not add animations/effects in Milestone 7
	•	Do not rewrite words (no summarisation). Only line breaks.

⸻

The Replit prompt you should send (copy/paste)

Use this verbatim:

PROMPT TO REPLIT / CLAUDE

Build Milestone 7: TitleComposer as a new module, without modifying Milestone 6.

Non-negotiable constraints
	•	DO NOT modify these files or logic:
	•	client/src/caption-engine/layout/fit/**
	•	client/src/components/ScaleToFitCaption.tsx
	•	client/src/caption-engine/render/resolveStyles.ts
	•	TitleComposer is a pure function: string → string[] only.
	•	No DOM, no canvas, no styling in TitleComposer.
	•	No word rewriting, only line breaks.
	•	Output must be 1–3 lines.
	•	No orphan last line (1 word) unless it is numeric/percentage (eg “58%”).
	•	Prefer 2–4 words per line, allow 5 if needed.
	•	Deterministic output for same input.

Implementation tasks
	1.	Create folder: client/src/caption-engine/layout/title/
	2.	Create file: TitleComposer.ts exporting:
	•	composeTitleLines(text: string, opts?: TitleComposeOptions): string[]
	3.	Implement deterministic candidate-split scoring:
	•	Generate candidate splits for 1, 2, 3 lines
	•	Score candidates with penalties:
	•	orphan last line (unless numeric) = heavy penalty
	•	any line > 5 words = penalty
	•	imbalance in character lengths between lines = penalty
	•	Choose lowest penalty candidate
	4.	Create a test harness page:
	•	client/src/pages/caption-composer-lab.tsx
	•	Show a list of ~30 headline examples, and display:
	•	raw text
	•	composed lines
	•	final rendered panel using existing renderer
	5.	Wire TitleComposer into the caption pipeline upstream of fit-to-box:
	•	headlineText → composeTitleLines → fitTextToBox(lines.join('\n'))
	•	Ensure rendering respects line breaks (either split on \n or render lines[])

Acceptance criteria
	•	All headlines render with improved editorial cadence:
	•	max 3 lines
	•	no orphan last lines
	•	balanced line lengths
	•	Milestone 6 contract remains intact:
	•	never split mid-word
	•	no ellipsis
	•	all text fits in panel (fitter still guarantees)

Deliver: PR-ready implementation + harness page.

⸻

Quick thought on your “LOCKED” message

Keep that exact Milestone 6 spec in:
	•	/client/src/caption-engine/README.md
and paste it into the repo root docs/caption-engine.md too.

It becomes your “constitution”.

⸻

If you paste me your current integration point (the function that currently calls fitTextToBox or produces headlineLines[] in resolveStyles), I’ll tell you the one exact place TitleComposer should be inserted so it doesn’t contaminate the fitter or renderer.